# SPDX-License-Identifier: Apache-2.0 OR ISC OR MIT

name: Bench (Ubuntu PMU 512)

on:
  push:

permissions:
  contents: read

jobs:
  bench-pmu-512:
    name: Ubuntu PMU ML-KEM-512
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential python3

      - name: Build ML-KEM-512 benchmark (optimized)
        run: make bench_512 CYCLES=PMU OPT=1 -j"$(nproc)"

      - name: Run ML-KEM-512 benchmark (capture output)
        run: |
          make run_bench_512 CYCLES=PMU EXEC_WRAPPER="taskset -c 0" | tee bench_512.txt

      - name: Publish job summary
        run: |
          python3 - <<'PY'
          import os, re
          txt = open('bench_512.txt','r',encoding='utf-8',errors='ignore').read()
          m = dict(re.findall(r'(keypair cycles|encaps cycles|decaps cycles)\s*=\s*(\d+)', txt))
          rows = [
            ('keypair cycles','Keypair'),
            ('encaps cycles','Encaps'),
            ('decaps cycles','Decaps'),
          ]
          if not all(k in m for k,_ in rows):
            raise SystemExit('No cycle results found in bench_512.txt')
          lines = []
          lines.append('## ML-KEM-512 Cycle Counts (PMU/RDTSC)')
          lines.append('')
          lines.append('| Primitive | Cycles |')
          lines.append('|---|---:|')
          for key,label in rows:
            lines.append(f"| {label} | {int(m[key]):,} |")
          with open(os.environ['GITHUB_STEP_SUMMARY'],'a',encoding='utf-8') as f:
            f.write("\n".join(lines) + "\n")
          PY
